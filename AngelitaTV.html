<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AngelitaTV - Viewer</title>
  <link rel="icon" href="data:,">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #667eea;
      --secondary: #764ba2;
      --accent: #ff66cc;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      transition: background 0.5s ease;
    }

    body.purple { --primary: #667eea; --secondary: #764ba2; --accent: #ff66cc; }
    body.pink { --primary: #ec4899; --secondary: #be185d; --accent: #fda4af; }
    body.blue { --primary: #3b82f6; --secondary: #1e40af; --accent: #93c5fd; }
    body.green { --primary: #10b981; --secondary: #047857; --accent: #6ee7b7; }
    body.orange { --primary: #f97316; --secondary: #c2410c; --accent: #fdba74; }
    body.cyan { --primary: #06b6d4; --secondary: #0e7490; --accent: #67e8f9; }
    
    header { text-align: center; margin-bottom: 30px; animation: fadeIn 0.8s ease-in; }
    h1 { font-size: 3em; color: #ffffff; margin-bottom: 5px; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3); }
    .subtitle { font-size: 1.1em; color: #ffe4f1; opacity: 0.9; }

    .settings-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      font-size: 1.5em;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .settings-btn:hover { transform: rotate(90deg) scale(1.1); box-shadow: 0 0 20px rgba(255, 255, 255, 0.4); }

    .settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 998;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .settings-overlay.active { display: block; opacity: 1; }

    .settings-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 350px;
      height: 100vh;
      background: rgba(26, 26, 26, 0.98);
      backdrop-filter: blur(20px);
      padding: 30px;
      box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
      transition: right 0.4s ease;
      z-index: 999;
      overflow-y: auto;
    }

    .settings-panel.active { right: 0; }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    .settings-title { font-size: 1.5em; color: var(--accent); }
    .close-settings {
      background: none;
      border: none;
      color: white;
      font-size: 1.8em;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      transition: transform 0.2s ease;
    }

    .close-settings:hover { transform: scale(1.2); }
    .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px; }

    .theme-option {
      padding: 15px;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .theme-option:hover { transform: translateY(-3px); border-color: var(--accent); }
    .theme-option.active { border-color: var(--accent); background: rgba(255, 102, 204, 0.2); }
    .theme-preview { width: 100%; height: 40px; border-radius: 8px; margin-bottom: 8px; }
    
    #controls {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      max-width: 400px;
      width: 100%;
      animation: slideUp 0.6s ease-out;
    }
    
    .input-group { margin-bottom: 20px; }
    label { display: block; font-size: 0.9em; color: #ffccee; margin-bottom: 8px; font-weight: 500; }
    
    input {
      width: 100%;
      padding: 12px 15px;
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      font-size: 1em;
      transition: all 0.3s ease;
    }
    
    input::placeholder { color: rgba(255, 255, 255, 0.6); }
    input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 20px rgba(255, 102, 204, 0.4);
    }
    
    button {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--primary));
      color: #fff;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 102, 204, 0.4);
    }
    
    button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 102, 204, 0.6); }
    button:active { transform: translateY(0); }
    button:disabled { background: rgba(255, 255, 255, 0.2); cursor: not-allowed; transform: none; }
    
    #status {
      margin-top: 20px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      text-align: center;
      font-size: 0.95em;
      border-left: 4px solid var(--accent);
    }
    
    .video-container {
      margin-top: 30px;
      width: 100%;
      max-width: 1200px;
      position: relative;
      background: #000;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      display: none;
      animation: fadeIn 0.5s ease-in;
    }
    
    .video-container.active { display: block; }
    video { width: 100%; height: auto; display: block; background: #000; }
    
    .video-controls {
      background: linear-gradient(to top, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7), transparent);
      padding: 20px;
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      align-items: center;
      gap: 15px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 10;
    }
    
    .video-container:hover .video-controls { opacity: 1; }
    .volume-control { display: flex; align-items: center; gap: 10px; flex: 1; }
    .volume-icon { font-size: 1.5em; cursor: pointer; user-select: none; }
    
    #volumeSlider {
      flex: 1;
      max-width: 150px;
      height: 6px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.3);
      outline: none;
      -webkit-appearance: none;
    }
    
    #volumeSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255, 102, 204, 0.6);
    }
    
    #volumeSlider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: none;
    }
    
    .quality-indicator {
      background: rgba(255, 102, 204, 0.2);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.85em;
      border: 1px solid var(--accent);
      white-space: nowrap;
    }
    
    .fullscreen-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: #fff;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    .fullscreen-btn:hover { background: rgba(255, 255, 255, 0.3); }
    
    .stats {
      display: none;
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.9);
      padding: 15px;
      border-radius: 10px;
      font-size: 0.85em;
      line-height: 1.6;
      min-width: 200px;
      z-index: 10;
    }
    
    .stats.active { display: block; }
    .stats-title { color: var(--accent); font-weight: bold; margin-bottom: 8px; }

    .connection-status {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 0.85em;
      display: none;
      z-index: 10;
    }

    .connection-status.active { display: block; }
    .connection-status.checking { border: 2px solid #fbbf24; color: #fbbf24; }
    .connection-status.connected { border: 2px solid #10b981; color: #10b981; }
    .connection-status.failed { border: 2px solid #ef4444; color: #ef4444; }

    .video-container:fullscreen { width: 100vw; height: 100vh; max-width: 100vw; border-radius: 0; }
    .video-container:fullscreen video { width: 100%; height: 100%; object-fit: contain; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    
    @media (max-width: 768px) {
      h1 { font-size: 2em; }
      #controls { padding: 20px; }
      .video-controls { flex-wrap: wrap; padding: 15px; }
      .quality-indicator { order: 3; width: 100%; text-align: center; }
    }
  </style>
</head>
<body class="purple">
  <button class="settings-btn" id="settingsBtn">‚öôÔ∏è</button>
  <div class="settings-overlay" id="settingsOverlay"></div>

  <div class="settings-panel" id="settingsPanel">
    <div class="settings-header">
      <span class="settings-title">‚öôÔ∏è Personalizaci√≥n</span>
      <button class="close-settings" id="closeSettings">√ó</button>
    </div>

    <h3 style="margin-bottom: 15px; color: var(--accent);">üé® Temas de color</h3>
    <div class="theme-grid">
      <div class="theme-option active" data-theme="purple">
        <div class="theme-preview" style="background: linear-gradient(135deg, #667eea, #764ba2);"></div>
        <div>P√∫rpura Rosa</div>
      </div>
      <div class="theme-option" data-theme="pink">
        <div class="theme-preview" style="background: linear-gradient(135deg, #ec4899, #be185d);"></div>
        <div>Rosa Intenso</div>
      </div>
      <div class="theme-option" data-theme="blue">
        <div class="theme-preview" style="background: linear-gradient(135deg, #3b82f6, #1e40af);"></div>
        <div>Azul</div>
      </div>
      <div class="theme-option" data-theme="green">
        <div class="theme-preview" style="background: linear-gradient(135deg, #10b981, #047857);"></div>
        <div>Verde Esmeralda</div>
      </div>
      <div class="theme-option" data-theme="orange">
        <div class="theme-preview" style="background: linear-gradient(135deg, #f97316, #c2410c);"></div>
        <div>Naranja</div>
      </div>
      <div class="theme-option" data-theme="cyan">
        <div class="theme-preview" style="background: linear-gradient(135deg, #06b6d4, #0e7490);"></div>
        <div>Cian</div>
      </div>
    </div>
  </div>

  <header>
    <h1>üì∫ AngelitaTV</h1>
    <p class="subtitle">Transmisi√≥n en vivo privada</p>
  </header>

  <div id="controls">
    <div class="input-group">
      <label for="roomId">üîë ID de Sala</label>
      <input type="text" id="roomId" placeholder="Ingresa el c√≥digo de sala" autocomplete="off" />
    </div>
    
    <div class="input-group">
      <label for="password">üîí Contrase√±a</label>
      <input type="password" id="password" placeholder="Contrase√±a de acceso" />
    </div>
    
    <button id="joinBtn">
      <span id="btnText">üé¨ Conectarse a la transmisi√≥n</span>
    </button>
    
    <div id="status">‚è≥ Esperando conexi√≥n...</div>
  </div>

  <div class="video-container" id="videoContainer">
    <video id="remoteVideo" autoplay playsinline></video>
    
    <div class="connection-status" id="connectionStatus">
      <span id="connectionText">Conectando...</span>
    </div>
    
    <div class="stats" id="stats">
      <div class="stats-title">üìä Estad√≠sticas</div>
      <div>Estado: <span id="connState">Conectando...</span></div>
      <div>ICE: <span id="iceState">Nuevo</span></div>
      <div>Bitrate: <span id="bitrate">-- kbps</span></div>
      <div>FPS: <span id="fpsDisplay">--</span></div>
      <div>Resoluci√≥n: <span id="resolution">--</span></div>
      <div>Paquetes perdidos: <span id="packetsLost">0</span></div>
    </div>
    
    <div class="video-controls">
      <div class="volume-control">
        <span class="volume-icon" id="volumeIcon">üîä</span>
        <input type="range" id="volumeSlider" min="0" max="100" value="100" />
      </div>
      
      <div class="quality-indicator">
        <span id="quality">Conectando...</span>
      </div>
      
      <button class="fullscreen-btn" id="fullscreenBtn" title="Pantalla completa">‚õ∂</button>
      <button class="fullscreen-btn" id="statsBtn" title="Ver estad√≠sticas">üìä</button>
    </div>
  </div>

  <script>
    const CONFIG = {
      signalingUrl: "wss://cucaracha-server.onrender.com",
      maxReconnects: 3,
      iceServers: [
        { urls: ["stun:stun.l.google.com:19302", "stun:stun1.l.google.com:19302"] },
        { urls: "stun:global.stun.twilio.com:3478" },
        {
          urls: ["turn:openrelay.metered.ca:80", "turn:openrelay.metered.ca:443"],
          username: "openrelayproject",
          credential: "openrelayproject"
        },
        {
          urls: ["turn:a.relay.metered.ca:80", "turn:a.relay.metered.ca:443"],
          username: "87c4a8b8e928d97b360eec55",
          credential: "F/WHZFGjGKurYCOM"
        }
      ]
    };

    const state = {
      ws: null,
      pc: null,
      roomId: null,
      statsInterval: null,
      reconnectAttempts: 0,
      iceCandidateQueue: []
    };

    const elements = {
      video: document.getElementById("remoteVideo"),
      container: document.getElementById("videoContainer"),
      joinBtn: document.getElementById("joinBtn"),
      status: document.getElementById("status"),
      quality: document.getElementById("quality"),
      connectionStatus: document.getElementById("connectionStatus"),
      connectionText: document.getElementById("connectionText"),
      volumeSlider: document.getElementById("volumeSlider"),
      volumeIcon: document.getElementById("volumeIcon")
    };

    // Gesti√≥n de temas
    const themeManager = {
      init() {
        const saved = localStorage.getItem('angelitatv-theme') || 'purple';
        document.body.className = saved;
        
        document.querySelectorAll('.theme-option').forEach(opt => {
          if (opt.dataset.theme === saved) opt.classList.add('active');
          opt.onclick = () => this.setTheme(opt.dataset.theme);
        });
      },
      setTheme(theme) {
        document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
        event.target.closest('.theme-option').classList.add('active');
        document.body.className = theme;
        localStorage.setItem('angelitatv-theme', theme);
      }
    };

    // Configuraci√≥n de paneles
    const settingsManager = {
      panel: document.getElementById('settingsPanel'),
      overlay: document.getElementById('settingsOverlay'),
      toggle(show) {
        this.panel.classList.toggle('active', show);
        this.overlay.classList.toggle('active', show);
      }
    };

    document.getElementById('settingsBtn').onclick = () => settingsManager.toggle(true);
    document.getElementById('closeSettings').onclick = () => settingsManager.toggle(false);
    document.getElementById('settingsOverlay').onclick = () => settingsManager.toggle(false);

    // Utilidades
    const utils = {
      updateStatus(msg, quality = null) {
        elements.status.textContent = msg;
        if (quality) elements.quality.textContent = quality;
      },
      
      updateConnectionStatus(state, text) {
        elements.connectionStatus.className = `connection-status active ${state}`;
        elements.connectionText.textContent = text;
      }
    };

    // Estad√≠sticas
    const statsManager = {
      lastBytes: 0,
      lastTime: Date.now(),
      
      start() {
        state.statsInterval = setInterval(() => this.update(), 1000);
      },
      
      async update() {
        if (!state.pc) return;
        
        try {
          const stats = await state.pc.getStats();
          stats.forEach(report => {
            if (report.type === 'inbound-rtp' && report.kind === 'video') {
              this.updateBitrate(report);
              this.updateVideoStats(report);
            }
          });
        } catch (err) {
          console.error("Error obteniendo stats:", err);
        }
      },
      
      updateBitrate(report) {
        if (report.bytesReceived && this.lastBytes > 0) {
          const now = Date.now();
          const bitrate = Math.round(
            ((report.bytesReceived - this.lastBytes) * 8) / 
            ((now - this.lastTime) / 1000) / 1000
          );
          document.getElementById("bitrate").textContent = bitrate + " kbps";
          this.lastBytes = report.bytesReceived;
          this.lastTime = now;
        } else {
          this.lastBytes = report.bytesReceived;
          this.lastTime = Date.now();
        }
      },
      
      updateVideoStats(report) {
        if (report.framesPerSecond) {
          document.getElementById("fpsDisplay").textContent = Math.round(report.framesPerSecond);
        }
        if (report.frameWidth && report.frameHeight) {
          document.getElementById("resolution").textContent = `${report.frameWidth}x${report.frameHeight}`;
        }
        if (report.packetsLost !== undefined) {
          document.getElementById("packetsLost").textContent = report.packetsLost;
        }
      }
    };

    // WebRTC
    const rtcManager = {
      init() {
        state.pc = new RTCPeerConnection({
          iceServers: CONFIG.iceServers,
          iceCandidatePoolSize: 10,
          bundlePolicy: 'max-bundle',
          rtcpMuxPolicy: 'require'
        });

        state.pc.onicecandidate = (e) => {
          if (e.candidate) {
            console.log("üì§ Enviando candidato ICE al emisor:", e.candidate.type);
            state.ws.send(JSON.stringify({
              type: "ice-candidate",
              candidate: e.candidate,
              room: state.roomId
            }));
          } else {
            console.log("‚úÖ Todos los candidatos ICE enviados");
          }
        };

        state.pc.ontrack = (e) => {
          console.log("üé• Stream recibido");
          elements.video.srcObject = e.streams[0];
          elements.container.classList.add("active");
          elements.connectionStatus.classList.add("active");
          
          utils.updateStatus("‚úÖ Stream conectado - Cargando video...", "Buffering...");
          utils.updateConnectionStatus('connected', '‚úÖ Recibiendo');
          
          const audioTracks = e.streams[0].getAudioTracks();
          console.log(`üîä Audio: ${audioTracks.length > 0 ? 'S√≠' : 'No'}`);
          
          statsManager.start();
        };

        state.pc.onconnectionstatechange = () => {
          const connectionState = state.pc.connectionState;
          console.log("üîÑ Estado de conexi√≥n:", connectionState);
          document.getElementById("connState").textContent = connectionState;
          
          const stateMap = {
            connected: ["‚úÖ Conectado - Transmisi√≥n en vivo", "En vivo", "connected", "‚úÖ En vivo"],
            connecting: ["üîó Estableciendo conexi√≥n...", "Conectando...", "checking", "üîÑ Conectando..."],
            failed: ["‚ùå Conexi√≥n fallida", "Error", "failed", "‚ùå Fall√≥"],
            disconnected: ["‚ö†Ô∏è Conexi√≥n interrumpida", "Desconectado", "failed", "‚ö†Ô∏è Desconectado"]
          };
          
          if (stateMap[connectionState]) {
            const [status, quality, connClass, connText] = stateMap[connectionState];
            utils.updateStatus(status, quality);
            utils.updateConnectionStatus(connClass, connText);
            if (connectionState === 'connected') state.reconnectAttempts = 0;
            if (connectionState === 'disconnected') elements.container.classList.remove("active");
          }
        };

        state.pc.oniceconnectionstatechange = () => {
          const iceState = state.pc.iceConnectionState;
          console.log("üßä Estado ICE:", iceState);
          document.getElementById("iceState").textContent = iceState;
          
          if (iceState === 'failed') {
            utils.updateStatus("‚ùå No se pudo conectar (firewall/NAT)");
            utils.updateConnectionStatus('failed', '‚ùå Firewall/NAT');
          } else if (iceState === 'checking') {
            utils.updateConnectionStatus('checking', 'üîÑ Verificando ruta...');
          } else if (iceState === 'connected' || iceState === 'completed') {
            utils.updateConnectionStatus('connected', '‚úÖ Conectado');
          }
        };
      },

      async handleOffer(offer) {
        utils.updateStatus("üîó Procesando oferta...", "Conectando...");
        utils.updateConnectionStatus('checking', 'üîÑ Conectando...');
        
        try {
          console.log("‚è≥ Estableciendo descripci√≥n remota...");
          await state.pc.setRemoteDescription(new RTCSessionDescription(offer));
          console.log("‚úÖ Descripci√≥n remota establecida");
          
          // Procesar candidatos en cola
          console.log(`üì¶ Procesando ${state.iceCandidateQueue.length} candidatos ICE en cola`);
          while (state.iceCandidateQueue.length > 0) {
            const candidate = state.iceCandidateQueue.shift();
            try {
              await state.pc.addIceCandidate(new RTCIceCandidate(candidate));
              console.log("‚úÖ Candidato ICE en cola procesado:", candidate.type);
            } catch (error) {
              console.error("‚ùå Error al procesar candidato:", error);
            }
          }
          
          console.log("‚è≥ Creando respuesta (answer)...");
          const answer = await state.pc.createAnswer();
          console.log("‚úÖ Answer creado");
          
          await state.pc.setLocalDescription(answer);
          console.log("‚úÖ Descripci√≥n local establecida");
          
          console.log("üì§ Enviando answer al emisor...");
          state.ws.send(JSON.stringify({ 
            type: "answer", 
            answer, 
            room: state.roomId 
          }));
          console.log("‚úÖ Answer enviado exitosamente");
          
          utils.updateStatus("‚è≥ Esperando stream de video...", "Esperando...");
          
        } catch (err) {
          console.error("‚ùå Error al procesar oferta:", err);
          utils.updateStatus("‚ùå Error: " + err.message);
          utils.updateConnectionStatus('failed', '‚ùå Error');
          alert("Error al procesar la oferta: " + err.message);
        }
      },

      handleIceCandidate(candidate) {
        if (!state.pc.remoteDescription) {
          console.log("‚è≥ Candidato ICE en cola (esperando offer)");
          state.iceCandidateQueue.push(candidate);
        } else {
          state.pc.addIceCandidate(new RTCIceCandidate(candidate))
            .then(() => console.log("‚úÖ Candidato ICE agregado:", candidate.type))
            .catch(err => console.error("‚ùå Error al agregar candidato:", err));
        }
      }
    };

    // WebSocket
    function connectWebSocket(roomId, password) {
      state.roomId = roomId;
      utils.updateStatus("üîå Conectando al servidor...");
      state.ws = new WebSocket(CONFIG.signalingUrl);

      state.ws.onopen = () => {
        console.log("‚úÖ Conectado al servidor");
        rtcManager.init();
        state.ws.send(JSON.stringify({ type: "join", room: roomId, password }));
        utils.updateStatus("‚è≥ Esperando transmisi√≥n...", "Esperando...");
      };

      state.ws.onmessage = async (e) => {
        const data = JSON.parse(e.data);
        console.log("üì© Mensaje recibido:", data.type);

        switch(data.type) {
          case "offer":
            console.log("üì• Oferta recibida del emisor");
            await rtcManager.handleOffer(data.offer);
            break;
          case "ice-candidate":
            if (data.candidate) {
              console.log("üì® Candidato ICE recibido:", data.candidate.type);
              rtcManager.handleIceCandidate(data.candidate);
            }
            break;
          case "error":
            utils.updateStatus("‚ùå " + data.message, "Error");
            utils.updateConnectionStatus('failed', '‚ùå ' + data.message);
            elements.joinBtn.disabled = false;
            document.getElementById("btnText").textContent = "üé¨ Reintentar";
            alert(data.message);
            break;
        }
      };

      state.ws.onerror = (error) => {
        console.error("‚ùå Error WebSocket:", error);
        utils.updateStatus("‚ùå Error de conexi√≥n al servidor");
        elements.joinBtn.disabled = false;
      };

      state.ws.onclose = () => {
        console.log("üîå WebSocket cerrado");
        utils.updateStatus("‚ùå Desconectado del servidor", "Desconectado");
        utils.updateConnectionStatus('failed', '‚ùå Desconectado');
        if (state.statsInterval) clearInterval(state.statsInterval);
        
        if (state.reconnectAttempts < CONFIG.maxReconnects && elements.container.classList.contains('active')) {
          state.reconnectAttempts++;
          console.log(`üîÑ Reconexi√≥n ${state.reconnectAttempts}/${CONFIG.maxReconnects}`);
          utils.updateStatus(`üîÑ Reconectando... (${state.reconnectAttempts}/${CONFIG.maxReconnects})`);
          setTimeout(() => connectWebSocket(roomId, password), 2000);
        }
      };
    }

    // Controles de video
    const videoControls = {
      init() {
        elements.volumeSlider.addEventListener("input", () => this.updateVolume());
        elements.volumeIcon.addEventListener("click", () => this.toggleMute());
        document.getElementById('fullscreenBtn').addEventListener("click", () => this.toggleFullscreen());
        document.getElementById('statsBtn').addEventListener("click", () => this.toggleStats());
        document.addEventListener("keydown", (e) => this.handleKeyboard(e));
        
        // Eventos de video
        elements.video.addEventListener('loadedmetadata', () => {
          console.log(`‚úÖ Video: ${elements.video.videoWidth}x${elements.video.videoHeight}`);
          utils.updateStatus("‚úÖ Video cargado - Iniciando reproducci√≥n...", "Iniciando...");
          utils.updateConnectionStatus('connected', '‚úÖ Cargado');
        });

        elements.video.addEventListener('playing', () => {
          console.log("‚ñ∂Ô∏è Reproduciendo");
          utils.updateStatus("‚úÖ Reproduciendo transmisi√≥n en vivo", "En vivo");
          utils.updateConnectionStatus('connected', '‚úÖ En vivo');
        });

        elements.video.addEventListener('waiting', () => {
          utils.updateStatus("‚è≥ Buffering...", "Buffering...");
        });

        elements.video.addEventListener('error', (e) => {
          console.error("‚ùå Error video:", elements.video.error);
          utils.updateStatus("‚ùå Error al reproducir video");
          utils.updateConnectionStatus('failed', '‚ùå Error video');
        });
      },

      updateVolume() {
        const volume = elements.volumeSlider.value / 100;
        elements.video.volume = volume;
        
        const icons = { 0: "üîá", 0.5: "üîâ", 1: "üîä" };
        elements.volumeIcon.textContent = volume === 0 ? icons[0] : volume < 0.5 ? icons[0.5] : icons[1];
      },

      toggleMute() {
        if (elements.video.volume > 0) {
          elements.video.volume = 0;
          elements.volumeSlider.value = 0;
          elements.volumeIcon.textContent = "üîá";
        } else {
          elements.video.volume = 1;
          elements.volumeSlider.value = 100;
          elements.volumeIcon.textContent = "üîä";
        }
      },

      toggleFullscreen() {
        if (!document.fullscreenElement) {
          const methods = [
            elements.container.requestFullscreen,
            elements.container.webkitRequestFullscreen,
            elements.container.mozRequestFullScreen
          ];
          methods.find(m => m)?.call(elements.container);
        } else {
          const methods = [
            document.exitFullscreen,
            document.webkitExitFullscreen,
            document.mozCancelFullScreen
          ];
          methods.find(m => m)?.call(document);
        }
      },

      toggleStats() {
        document.getElementById('stats').classList.toggle('active');
      },

      handleKeyboard(e) {
        if (!elements.container.classList.contains("active")) return;
        
        const keyMap = {
          'f': () => this.toggleFullscreen(),
          'F': () => this.toggleFullscreen(),
          ' ': (e) => {
            e.preventDefault();
            elements.video.paused ? elements.video.play() : elements.video.pause();
          },
          'm': () => this.toggleMute(),
          'M': () => this.toggleMute()
        };
        
        keyMap[e.key]?.(e);
      }
    };

    // Event Listeners principales
    elements.joinBtn.onclick = () => {
      const roomId = document.getElementById("roomId").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!roomId || !password) {
        utils.updateStatus("‚ö†Ô∏è Por favor ingresa ID y contrase√±a");
        return;
      }

      elements.joinBtn.disabled = true;
      document.getElementById("btnText").textContent = "‚è≥ Conectando...";
      state.reconnectAttempts = 0;
      state.iceCandidateQueue.length = 0;
      connectWebSocket(roomId, password);
    };

    // Inicializar
    themeManager.init();
    videoControls.init();
  </script>
</body>
</html>
