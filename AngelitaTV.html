<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AngelitaTV</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0f0f0f;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    h1 {
      color: #ff66cc;
    }
    #controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      background: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 102, 204, 0.3);
    }
    input, button {
      padding: 8px 10px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
    }
    input {
      width: 220px;
      text-align: center;
    }
    button {
      background-color: #ff66cc;
      color: #fff;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background-color: #ff99dd;
    }
    #status {
      margin-top: 15px;
      font-size: 14px;
      color: #ccc;
    }
    video {
      margin-top: 25px;
      width: 90%;
      max-width: 900px;
      background-color: #000;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
    }
    #volumeControl {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 15px;
    }
    #volumeSlider {
      width: 200px;
    }
  </style>
</head>
<body>
  <h1>ðŸ“º AngelitaTV</h1>

  <div id="controls">
    <input type="text" id="roomId" placeholder="ID de sala" />
    <input type="password" id="password" placeholder="ContraseÃ±a" />
    <button id="joinBtn">Conectarse</button>
    <div id="status">Esperando conexiÃ³n...</div>
  </div>

  <video id="remoteVideo" autoplay playsinline controls></video>

  <div id="volumeControl" style="display:none;">
    <label for="volumeSlider">ðŸ”Š Volumen</label>
    <input type="range" id="volumeSlider" min="0" max="100" value="100" />
  </div>

  <script>
    const signalingUrl = "wss://cucaracha-server.onrender.com";
    let ws, pc, currentRoom;
    const videoEl = document.getElementById("remoteVideo");
    const joinBtn = document.getElementById("joinBtn");
    const statusEl = document.getElementById("status");
    const volumeSlider = document.getElementById("volumeSlider");
    const volumeControl = document.getElementById("volumeControl");

    joinBtn.onclick = async () => {
      const roomId = document.getElementById("roomId").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!roomId || !password) {
        alert("Ingresa la ID de sala y contraseÃ±a.");
        return;
      }

      connectToRoom(roomId, password);
    };

    function connectToRoom(roomId, password) {
      currentRoom = roomId;
      statusEl.textContent = "ðŸ”Œ Conectando a la transmisiÃ³n...";
      ws = new WebSocket(signalingUrl);

      ws.onopen = () => {
        console.log("âœ… Conectado al servidor de seÃ±alizaciÃ³n (viewer)");
        
        // Inicializar PeerConnection ANTES de enviar join
        initializePeerConnection();
        
        // Ahora sÃ­ enviamos el join
        ws.send(JSON.stringify({ type: "join", room: roomId, password }));
        statusEl.textContent = "â³ Esperando transmisiÃ³n...";
      };

      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);
        console.log("ðŸ“© Mensaje recibido:", data.type);

        if (data.type === "offer") {
          console.log("ðŸ“¥ Oferta recibida, creando respuesta...");
          statusEl.textContent = "ðŸ”— Estableciendo conexiÃ³n...";
          
          await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          
          ws.send(JSON.stringify({ 
            type: "answer", 
            answer, 
            room: currentRoom 
          }));
          
          console.log("âœ… Respuesta enviada");
        } else if (data.type === "ice-candidate") {
          console.log("ðŸ§Š Candidato ICE recibido");
          try {
            if (pc.remoteDescription) {
              await pc.addIceCandidate(data.candidate);
            }
          } catch (err) {
            console.error("âŒ Error ICE:", err);
          }
        } else if (data.type === "error") {
          statusEl.textContent = "âŒ Error: " + data.message;
          alert("âš ï¸ " + data.message);
        }
      };

      ws.onerror = (error) => {
        console.error("âŒ Error WebSocket:", error);
        statusEl.textContent = "âŒ Error de conexiÃ³n";
      };

      ws.onclose = () => {
        console.log("ðŸ”Œ WebSocket cerrado");
        statusEl.textContent = "âŒ Desconectado del servidor";
      };
    }

    function initializePeerConnection() {
      console.log("ðŸ”§ Inicializando PeerConnection...");
      
      pc = new RTCPeerConnection({
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" }
        ]
      });

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          console.log("ðŸ§Š Enviando candidato ICE");
          ws.send(JSON.stringify({
            type: "ice-candidate",
            candidate: event.candidate,
            room: currentRoom
          }));
        }
      };

      pc.ontrack = (event) => {
        console.log("ðŸŽ¥ Stream recibido!");
        statusEl.textContent = "ðŸŽ¥ Viendo transmisiÃ³n en vivo";
        videoEl.srcObject = event.streams[0];
        volumeControl.style.display = "flex";
      };

      pc.onconnectionstatechange = () => {
        console.log("ðŸ”„ Estado de conexiÃ³n:", pc.connectionState);
        if (pc.connectionState === "connected") {
          statusEl.textContent = "âœ… Conectado - TransmisiÃ³n activa";
        } else if (pc.connectionState === "failed" || pc.connectionState === "disconnected") {
          statusEl.textContent = "âŒ ConexiÃ³n perdida";
        }
      };

      pc.oniceconnectionstatechange = () => {
        console.log("ðŸ§Š Estado ICE:", pc.iceConnectionState);
      };
    }

    volumeSlider.addEventListener("input", () => {
      const volume = volumeSlider.value / 100;
      videoEl.volume = volume;
    });
  </script>
</body>
</html>